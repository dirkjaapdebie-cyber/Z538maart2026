<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Z53 Hebreeën Les 2</title>
    <style>
        :root { --bg: #fdfcf8; --primary: #2c3e50; --accent: #8e44ad; --text: #34495e; }
        body { font-family: 'Georgia', serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; }
        .container { max-width: 800px; margin: 20px auto; padding: 20px; padding-bottom: 180px; }
        
        .header-flex { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; margin-bottom: 30px; padding-bottom: 10px; }
        .main-header { color: var(--primary); margin: 0; font-size: 1.5rem; }
        .top-reset-btn { background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }

        .screen { display: none; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #eee; min-height: 450px; }
        .active { display: block; animation: fadeIn 0.4s; }
        
        .bible-text-box { background: #fffcf0; padding: 25px; border: 1px solid #ddd; line-height: 1.7; max-height: 500px; overflow-y: auto; border-radius: 6px; }
        .cv-title { font-weight: bold; color: var(--primary); text-transform: uppercase; border-bottom: 1px solid #ccc; margin-bottom: 8px; display: block; margin-top: 15px; }

        .admin-bar { position: fixed; bottom: 0; left:0; width: 100%; background: #1a1a1a; padding: 15px; display: flex; overflow-x: auto; gap: 10px; z-index: 1000; }
        .screen-btn { background: #444; color: white; border: none; padding: 12px 18px; border-radius: 6px; white-space: nowrap; cursor: pointer; }
        .current-btn { background: var(--accent) !important; font-weight: bold; }
        
        .canvas { position: relative; height: 500px; border: 2px dashed #ccc; background: #fff; overflow: hidden; touch-action: none; margin-top: 10px; border-radius: 8px; }
        .draggable { position: absolute; padding: 12px 20px; background: white; border: 2px solid var(--primary); border-radius: 30px; cursor: move; box-shadow: 0 4px 8px rgba(0,0,0,0.15); font-weight: bold; white-space: nowrap; touch-action: none; user-select: none; }
        
        .feed-item { padding: 10px; border-bottom: 1px solid #eee; background: #f9f9f9; margin-top: 5px; border-radius: 4px; font-style: italic; }
        input[type="text"] { padding: 12px; border: 1px solid #ccc; width: 60%; border-radius: 4px; font-size: 16px; }
        .action-btn { background: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 4px; cursor: pointer; margin-left: 5px; font-weight: bold; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <div class="header-flex">
        <h1 class="main-header">Hebreeën Les 2</h1>
        <button class="top-reset-btn" onclick="window.resetAllData()">RESET APP</button>
    </div>
    <div id="main-container"></div>
</div>

<div class="admin-bar" id="admin-bar"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, doc, onSnapshot, setDoc, collection, addDoc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCcC2ZvkbWDuXLWSGmCpM2wfBnm65UYrbQ",
        authDomain: "z53bijbelstudie.firebaseapp.com",
        projectId: "z53bijbelstudie",
        storageBucket: "z53bijbelstudie.firebasestorage.app",
        messagingSenderId: "86708654444",
        appId: "1:86708654444:web:729295ba18f564b841a349"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const screenConfigs = {
        login: { title: 'Inloggen', type: 'input', label: 'Je naam:', dbCol: 'names', field: 'name' },
        goals: { 
            title: 'Doelen', 
            type: 'info', 
            content: 'Doelen voor vandaag:<br><br><strong>1. Hiërarchie</strong> (Wie staat er boven wie?)<br><strong>2. ... en ik dan?</strong> (Mijn plek in de woestijn)<br><strong>3. ... en wij dan?</strong> (Samen het huis van God)' 
        },
        mozes_cv: { title: '1. Mozes CV', type: 'bible', text: `
            <span class="cv-title">Wie ben ik?</span> Een trouwe dienaar in Gods huis.<br>
            <span class="cv-title">Wat heb ik gedaan?</span>
            • Prins van Egypte geweest.<br>
            • Het volk bevrijd uit de slavernij.<br>
            • De wetgeving verzorgd.<br>
            • 40 jaar trouwe dienst in de woestijn.<br>
            <span class="cv-title">Vaardigheid</span> Dienstbaarheid.<br><br>
            <em>De les: Mozes was een dienaar IN het huis, maar Jezus is de Zoon OVER het huis.</em>
        ` },
        reading: { title: 'De Tekst', type: 'bible', text: `Hebreeën 3:1-14\n\nKijk naar Jezus. Hij is meer eer waard dan Mozes. Mozes was trouw als dienaar, maar Jezus als de Zoon die het huis Zelf gebouwd heeft. Dat huis, dat zijn WIJ.` },
        woestijn_cv: { title: '2. Woestijn CV', type: 'bible', text: `
            <span class="cv-title">Wie ben ik?</span> Ik ben bevrijd, maar ik moet nog leren leven als een vrij mens.<br>
            <span class="cv-title">Mijn leven nu</span>
            • Elke dag manna (saai, maar het houdt me in leven).<br>
            • Wandelen en wachten achter de wolk.<br>
            • Terugdenken aan de 'vleespannen' van Egypte.<br>
            <span class="cv-title">Status</span> Bevrijd, maar nog niet sterk.<br><br>
            <em>De les: God haalde het volk in één dag uit Egypte, maar had 40 jaar nodig om de slavernij uit hun hoofd te krijgen.</em>
        ` },
        beloofde_land_cv: { title: '3. Binnentreder CV', type: 'bible', text: `
            <span class="cv-title">Wie zijn wij?</span> Het huis van God dat samen de rust binnengaat.<br>
            <span class="cv-title">Onze focus (Numeri 13)</span>
            • Wij weigeren onszelf als 'sprinkhanen' te zien.<br>
            • Wij zien de reuzen, maar we vertrouwen op de Bouwer van het huis.<br>
            • Wij moedigen elkaar aan om niet af te haken.<br>
            <span class="cv-title">Vaardigheid</span> Samen vasthouden aan het vertrouwen.<br><br>
            <em>De les: Het Beloofde Land is geen solo-reis, we trekken samen op als Gods huis.</em>
        ` },
        q1: { title: 'Vragen', type: 'qa', label: 'Wat raakt je in deze vergelijking?', dbCol: 'answers_1', field: 'text' },
        lines: { title: 'Schrijf Regel', type: 'input', label: 'Typ een zin voor onze psalm:', dbCol: 'poem_lines', field: 'text' },
        creation: { title: 'Onze Psalm', type: 'dragdrop', dbCol: 'poem_lines' },
        blessing: { title: 'Zegen', type: 'info', content: 'Ga in vrede.' }
    };

    let currentOrder = Object.keys(screenConfigs);

    window.resetAllData = async () => {
        if(confirm("Systeem resetten?")){
            await deleteDoc(doc(db, "appState", "order"));
            for(const c of ['names', 'answers_1', 'poem_lines']) {
                const q = await getDocs(collection(db, c));
                q.forEach(d => deleteDoc(doc(db, c, d.id)));
            }
            location.reload();
        }
    };

    window.sendData = async (id, col, field) => {
        const val = document.getElementById(`in-${id}`).value;
        if (val) { 
            await addDoc(collection(db, col), { [field]: val, timestamp: Date.now() }); 
            document.getElementById(`in-${id}`).value = ""; 
        }
    };

    window.updateRemoteScreen = async (id) => { 
        await setDoc(doc(db, "appState", "current"), { activeScreen: id }, { merge: true }); 
    };

    function setupPrivateDragging(el) {
        let isDragging = false;
        el.onpointerdown = (e) => { isDragging = true; el.setPointerCapture(e.pointerId); el.style.zIndex = "1000"; };
        el.onpointermove = (e) => {
            if (!isDragging) return;
            const r = el.parentElement.getBoundingClientRect();
            el.style.left = (e.clientX - r.left - (el.offsetWidth / 2)) + "px";
            el.style.top = (e.clientY - r.top - (el.offsetHeight / 2)) + "px";
        };
        el.onpointerup = (e) => { isDragging = false; el.releasePointerCapture(e.pointerId); };
    }

    function renderApp() {
        const container = document.getElementById('main-container');
        const adminBar = document.getElementById('admin-bar');
        container.innerHTML = ""; adminBar.innerHTML = "";
        currentOrder.forEach((id) => {
            const s = screenConfigs[id];
            const div = document.createElement('div');
            div.id = `screen-${id}`; div.className = 'screen';
            let html = `<h2>${s.title}</h2>`;
            if (s.type === 'info') html += `<div>${s.content}</div>`;
            if (s.type === 'bible') html += `<div class="bible-text-box">${s.text}</div>`;
            if (s.type === 'input' || s.type === 'qa') {
                html += `<p>${s.label}</p><div style="display:flex;"><input type="text" id="in-${id}"><button class="action-btn" onclick="sendData('${id}','${s.dbCol}','${s.field}')">OK</button></div><div id="feed-${id}"></div>`;
            }
            if (s.type === 'dragdrop') html += `<div id="canvas-${id}" class="canvas"></div>`;
            div.innerHTML = html; container.appendChild(div);
            
            const btn = document.createElement('button');
            btn.className = 'screen-btn'; btn.id = `btn-${id}`; btn.innerText = s.title;
            btn.onclick = () => window.updateRemoteScreen(id);
            adminBar.appendChild(btn);
        });
    }

    function initListeners() {
        currentOrder.forEach(id => {
            const s = screenConfigs[id];
            if (s && s.dbCol) {
                onSnapshot(collection(db, s.dbCol), (snap) => {
                    const feed = document.getElementById(`feed-${id}`);
                    const canvas = document.getElementById(`canvas-${id}`);
                    if (feed) feed.innerHTML = snap.docs.map(d => `<div class="feed-item">${d.data().text || d.data().name}</div>`).join("");
                    if (canvas) {
                        snap.docs.forEach((docSnap, index) => {
                            if (!document.getElementById(`drag-${docSnap.id}`)) {
                                const el = document.createElement('div');
                                el.id = `drag-${docSnap.id}`; el.className = 'draggable';
                                el.innerText = docSnap.data().text;
                                el.style.top = (20 + (index * 60)) + "px"; el.style.left = "20px";
                                canvas.appendChild(el); setupPrivateDragging(el);
                            }
                        });
                    }
                });
            }
        });
    }

    onSnapshot(doc(db, "appState", "order"), (snap) => { 
        if (snap.exists()) { currentOrder = snap.data().sequence; } 
        renderApp(); initListeners(); 
    });

    onSnapshot(doc(db, "appState", "current"), (snap) => {
        const activeId = snap.data()?.activeScreen || 'login';
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(`screen-${activeId}`)?.classList.add('active');
        document.querySelectorAll('.screen-btn').forEach(b => b.classList.remove('current-btn'));
        const btn = document.getElementById(`btn-${activeId}`);
        if(btn) btn.classList.add('current-btn');
    });

    renderApp(); initListeners();
</script>
</body>
</html>

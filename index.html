<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Z53 Hebreeën Les 2 - Groepsmonitor</title>
    <style>
        :root { --bg: #fdfcf8; --primary: #2c3e50; --accent: #8e44ad; --text: #34495e; --gold: #f1c40f; }
        body { font-family: 'Georgia', serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; }
        .container { max-width: 800px; margin: 20px auto; padding: 20px; padding-bottom: 180px; }
        .header-flex { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; margin-bottom: 30px; padding-bottom: 10px; }
        .main-header { color: var(--primary); margin: 0; font-size: 1.5rem; }
        .top-reset-btn { background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        
        .screen { display: none; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #eee; min-height: 550px; }
        .active { display: block; animation: fadeIn 0.4s; }
        .scroll-box { background: #fffcf0; padding: 20px; border: 1px solid #ddd; line-height: 1.7; height: 450px; overflow-y: auto; border-radius: 6px; white-space: pre-wrap; }
        
        .cv-title { font-weight: bold; color: var(--accent); text-transform: uppercase; border-bottom: 1px solid #ccc; margin-bottom: 8px; display: block; margin-top: 15px; }
        
        .admin-bar { position: fixed; bottom: 0; left:0; width: 100%; background: #1a1a1a; padding: 15px; display: flex; overflow-x: auto; gap: 20px; z-index: 1000; align-items: flex-start; }
        .screen-btn { background: #444; color: white; border: none; padding: 12px 18px; border-radius: 6px; white-space: nowrap; cursor: pointer; }
        .current-btn { background: var(--accent) !important; font-weight: bold; }
        
        .canvas { position: relative; height: 500px; border: 2px dashed #ccc; background: #fff; overflow: hidden; touch-action: none; margin-top: 10px; border-radius: 8px; }
        .draggable { position: absolute; padding: 10px 20px; background: white; border: 2px solid var(--primary); border-radius: 30px; cursor: move; box-shadow: 0 4px 8px rgba(0,0,0,0.1); font-weight: bold; white-space: nowrap; touch-action: none; user-select: none; }
        /* Klein lettertype voor Onze Psalm items */
        .canvas-creation .draggable { font-size: 0.85rem; padding: 6px 15px; }
        .item-Jezus { border-color: var(--gold); border-width: 3px; background: #fffef0; box-shadow: 0 0 10px rgba(241,196,15,0.4); }
        .item-God { border-color: #c0392b; border-width: 3px; background: #fee; box-shadow: 0 0 10px rgba(192,57,43,0.3); }
        
        .monitor-vraag { background: #f9f9f9; border: 1px solid #eee; padding: 15px; margin-bottom: 20px; border-radius: 8px; border-left: 5px solid var(--accent); }
        .ans-pill { background: white; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; display: block; margin-top: 5px; font-style: italic; }
        .vraag-blok { margin-bottom: 25px; padding: 15px; background: #fff; border: 1px solid #eee; border-radius: 8px; }

        .admin-panel { background: #e8f4fd; padding: 15px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #3498db; }
        input[type="text"] { padding: 12px; border: 1px solid #ccc; width: 60%; border-radius: 4px; font-size: 16px; }
        .action-btn { background: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 4px; cursor: pointer; margin-left: 5px; font-weight: bold; }
        .arrow-btn { background: #555; color: white; border: none; padding: 4px 10px; cursor: pointer; border-radius: 4px; font-size: 12px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <div class="header-flex">
        <h1 class="main-header">Hebreeën Les 2</h1>
        <button class="top-reset-btn" onclick="window.resetAllData()">RESET APP</button>
    </div>
    <div id="main-container"></div>
</div>

<div id="admin-bar" class="admin-bar"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, doc, onSnapshot, setDoc, collection, addDoc, getDocs, deleteDoc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCcC2ZvkbWDuXLWSGmCpM2wfBnm65UYrbQ",
        authDomain: "z53bijbelstudie.firebaseapp.com",
        projectId: "z53bijbelstudie",
        storageBucket: "z53bijbelstudie.firebasestorage.app",
        messagingSenderId: "86708654444",
        appId: "1:86708654444:web:729295ba18f564b841a349"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let screenConfigs = {
        login: { title: 'Inloggen', type: 'input' },
        goals: { title: 'Doelen', type: 'info', content: '<strong>1. Hiërarchie</strong><br><strong>2. ... en ik dan?</strong><br><strong>3. ... en wij dan?</strong>' },
        mozes_cv: { title: '1. Mozes CV', type: 'bible', text: `<span class="cv-title">Wie ben ik?</span> Een trouwe dienaar in Gods huis.\n\n• Prins van Egypte geweest.\n• Het volk bevrijd.\n• 40 jaar dienst in de woestijn.` },
        hierarchy: { title: 'Hiërarchie', type: 'shared-drag', initial: ['God', 'Jezus', 'Mozes', 'Koning', 'Engel', 'Priester', 'Leiders', 'Profeten', 'Ik'] },
        reading: { title: 'De Tekst', type: 'bible', text: `<strong>Hebreeën 3:1-19 (HSV)</strong><br><br>[1] Daarom, heilige broeders, deelgenoten aan de hemelse roeping, let op de Apostel en Hogepriester van onze belijdenis: Christus Jezus.<br>[2] Hij is getrouw aan God, Die Hem aangesteld heeft, zoals ook Mozes trouw was in heel Zijn huis.<br>[3] Want Christus is zoveel meer heerlijkheid waard geacht dan Mozes, evenals hij die het huis gebouwd heeft, meer eer ontvangt dan het huis zelf.<br>[4] Immers, elk huis wordt door iemand gebouwd, maar Hij Die dit alles gebouwd heeft, is God.<br>[5] En Mozes is wel trouw geweest in heel Zijn huis, maar als dienaar, om te getuigen van wat later gesproken zou worden;<br>[6] Christus echter is getrouw over Zijn huis als Zoon. Zijn huis zijn wij, als wij tenminste de vrijmoedigheid en de roem van de hoop tot het einde toe onwrikbaar vasthouden.<br><br>[7] Daarom, zoals de Heilige Geest zegt: Heden, indien u Zijn stem hoort,<br>[8] verhard dan uw hart niet, zoals bij de verbittering, op de dag van de verzoeking in de woestijn.<br>[9] Daar hebben uw vaderen Mij verzocht; zij hebben Mij op de proef gesteld en Mijn werken gezien, veertig jaar lang.<br>[10] Daarom ben Ik toornig geworden op dat geslacht en heb gesproken: Altijd dwalen zij met hun hart, en zij hebben Mijn wegen niet gekend.<br>[11] Daarom heb Ik in Mijn toorn gezworen: Mijn rust zullen zij niet binnengaan!<br><br>[12] Zie erop toe, broeders, dat er nooit in iemand van u een verdorven hart zal zijn, vol ongeloof, om daardoor afvallig te worden van de levende God;<br>[13] maar vermaan elkaar elke dag, zolang men van een heden kan spreken, opdat niemand van u verhard zal worden door de verleiding van de zonde.<br>[14] Want wij hebben deel aan Christus gekregen, als wij tenminste het beginsel van de vaste grond van het geloof tot het einde toe onwrikbaar vasthouden,<br>[15] terwijl er wordt gezegd: Heden, als u Zijn stem hoort, verhard dan uw hart niet, zoals in de verbittering.<br><br>[16] Want hoewel sommigen die stem gehoord hadden, hebben zij Hem verbitterd, maar niet allen die onder leiding van Mozes uit Egypte waren getrokken.<br>[17] Op wie is Hij dan veertig jaar lang vertoornd geweest? Was het niet op hen die gezondigd hadden, van wie de lichamen zijn gevallen in de woestijn?<br>[18] En aan wie heeft Hij gezworen dat zij Zijn rust niet zouden binnengaan, dan aan hen die ongehoorzaam geweest waren?<br>[19] Zo zien wij dat zij niet konden ingaan vanwege hun ongeloof.` },
        woestijn_cv: { title: '2. Woestijn CV', type: 'bible', text: `<span class="cv-title">Wie ben ik?</span> Ik ben bevrijd, maar nog niet vrij.\n\n• Elke dag manna.\n• Leren vertrouwen.\n\n<em>De slavernij moet ook uit jou.</em>` },
        zinnen_input: { title: 'Zinnen Verzamelen', type: 'poem_input' },
        persoonlijk_cv_input: { title: 'Jouw CV Invullen', type: 'cv_input' },
        cv_monitor: { title: 'Live CV Feed', type: 'cv_feed' },
        binnentreder_cv: { title: '3. Binnentreder CV', type: 'bible', text: `<span class="cv-title">Wie zijn wij?</span> Binnentreders van het beloofde land.\n\n• <strong>Onze tactiek:</strong> Wij horen de stem en verharden ons hart niet.\n• <strong>Onze spionagedata:</strong> Ja, er zijn reuzen, maar hun bescherming is geweken.\n• <strong>Onze kracht:</strong> Wij zijn het huis van de Bouwer; Hij die alles gebouwd heeft is God.\n• <strong>Onze mindset:</strong> Niet terug naar Egypte, maar doorstoten naar de Rust.\n\n<em>Wij stappen over de drempel van ongeloof heen.</em>` },
        questions: { title: 'Vragen Invoer', type: 'qa_input' },
        monitor: { title: 'Monitor', type: 'qa_monitor' },
        creation: { title: 'Onze Psalm', type: 'dragdrop' },
        blessing: { title: 'Zegen', type: 'info', content: 'Vader, wij vragen U ons geloof in U te verdiepen. Geef ons de kracht om verleiding te weerstaan, twijfel te overwinnen en trouw aan U te blijven. Geef dat wij tot aan het eind van ons leven deze woorden mogen horen: ‘Voortreffelijk, je bent een goede en betrouwbare dienaar.Ga in vrede.' }
    };

    let currentActiveId = 'login';

    // --- Core Functies ---
    window.updateRemoteScreen = async (id) => { 
        await setDoc(doc(db, "appState", "current"), { activeScreen: id }, { merge: true }); 
    };

    window.moveScreen = (fromIndex, toIndex) => {
        const keys = Object.keys(screenConfigs);
        const item = keys.splice(fromIndex, 1)[0];
        keys.splice(toIndex, 0, item);
        const newOrder = {};
        keys.forEach(k => { newOrder[k] = screenConfigs[k]; });
        screenConfigs = newOrder;
        renderApp();
        updateVisuals();
    };

    window.sendData = async (id, col, field, qId = null) => {
        const val = document.getElementById(`in-${id}`).value;
        if (val) { 
            const data = { [field]: val, timestamp: Date.now() };
            if (qId) data.qId = qId;
            await addDoc(collection(db, col), data); 
            document.getElementById(`in-${id}`).value = ""; 
        }
    };

    window.addLiveQuestion = async () => {
        const val = document.getElementById('new-q-input').value;
        if(val) {
            await addDoc(collection(db, "live_questions"), { text: val, timestamp: Date.now() });
            document.getElementById('new-q-input').value = "";
        }
    };

    window.resetAllData = async () => {
        if(confirm("Alles resetten?")){
            await setDoc(doc(db, "appState", "current"), { activeScreen: 'login' });
            for(const c of ['names', 'answers_split', 'poem_lines', 'hierarchy_items', 'live_questions', 'user_cvs']) {
                const q = await getDocs(collection(db, c));
                for(const d of q.docs) { await deleteDoc(doc(db, c, d.id)); }
            }
            location.reload();
        }
    };

    function setupDragging(el, id, isShared) {
        let isDragging = false;
        
        // Pointer events voor live slepen
        el.onpointerdown = (e) => { 
            isDragging = true; 
            el.setPointerCapture(e.pointerId);
            el.classList.add('dragging');
        };
        
        el.onpointermove = (e) => {
            if (!isDragging) return;
            e.preventDefault();
            
            const r = el.parentElement.getBoundingClientRect();
            let newLeft = e.clientX - r.left - (el.offsetWidth / 2);
            let newTop = e.clientY - r.top - (el.offsetHeight / 2);
            
            newLeft = Math.max(0, Math.min(r.width - el.offsetWidth, newLeft));
            newTop = Math.max(0, Math.min(r.height - el.offsetHeight, newTop));
            
            el.style.left = newLeft + "px";
            el.style.top = newTop + "px";
        };
        
        el.onpointerup = async () => { 
            isDragging = false; 
            if(isShared) {
                // Alleen voor hiërarchie: positie opslaan in Firebase
                await updateDoc(doc(db, "hierarchy_items", id), { 
                    x: parseInt(el.style.left) || 0, 
                    y: parseInt(el.style.top) || 0 
                });
            }
            // Voor 'Onze Psalm' (isShared = false) gebeurt er niets met Firebase
            el.classList.remove('dragging');
        };
        
        // Zorg dat element standaard zichtbaar is
        if (!el.style.left || !el.style.top) {
            el.style.left = "20px";
            el.style.top = "20px";
        }
    }

    // --- Render App ---
    function renderApp() {
        const container = document.getElementById('main-container');
        const adminBar = document.getElementById('admin-bar');
        container.innerHTML = ""; adminBar.innerHTML = "";
        
        const keys = Object.keys(screenConfigs);
        keys.forEach((id, index, array) => {
            const s = screenConfigs[id];
            const div = document.createElement('div');
            div.id = `screen-${id}`; div.className = 'screen';
            let html = `<h2>${s.title}</h2>`;
            
            if (s.type === 'info') html += `<div>${s.content}</div>`;
            if (s.type === 'bible') html += `<div class="scroll-box">${s.text}</div>`;
            if (s.type === 'shared-drag') html += `<div id="canvas-hierarchy" class="canvas"></div>`;
            if (s.type === 'poem_input') html += `<div class="admin-panel">Typ een zin die je raakt.</div><input type="text" id="in-poem" placeholder="Jouw zin..."><button class="action-btn" onclick="sendData('poem','poem_lines','text')">STUUR</button>`;
            if (s.type === 'cv_input') html += `<div class="admin-panel">Wie ben jij in Gods huis? Typ een korte CV-omschrijving.</div><input type="text" id="in-usercv" placeholder="Ik ben..."><button class="action-btn" onclick="sendData('usercv','user_cvs','text')">VOEG TOE</button>`;
            if (s.type === 'cv_feed') html += `<div id="cv-live-feed" class="scroll-box"></div>`;
            if (s.type === 'qa_input') html += `<div class="admin-panel"><strong>Admin</strong><br><input type="text" id="new-q-input"><button class="action-btn" onclick="addLiveQuestion()">VRAAG TOEVOEGEN</button></div><div id="input-questions-container" class="scroll-box"></div>`;
            if (s.type === 'qa_monitor') html += `<div id="monitor-questions-container" class="scroll-box"></div>`;
            if (s.type === 'dragdrop') html += `<p>Sleep de binnengekomen zinnen tot een eigen psalm:</p><div id="canvas-creation" class="canvas canvas-creation"></div>`;
            if (s.type === 'input') html += `<input type="text" id="in-${id}" placeholder="Naam..."><button class="action-btn" onclick="sendData('${id}','names','name')">OK</button>`;

            div.innerHTML = html; container.appendChild(div);

            const btnWrap = document.createElement('div');
            btnWrap.style.display = "flex"; btnWrap.style.flexDirection = "column"; btnWrap.style.alignItems = "center";
            const btn = document.createElement('button');
            btn.className = 'screen-btn'; btn.id = `btn-${id}`; btn.innerText = s.title;
            btn.onclick = () => window.updateRemoteScreen(id);
            
            const arrows = document.createElement('div');
            arrows.style.marginTop = "5px"; arrows.style.display = "flex"; arrows.style.gap = "8px";
            arrows.innerHTML = `
                ${index > 0 ? `<button class="arrow-btn" onclick="moveScreen(${index}, ${index-1})">◀</button>` : '<div style="width:25px"></div>'}
                ${index < array.length - 1 ? `<button class="arrow-btn" onclick="moveScreen(${index}, ${index+1})">▶</button>` : '<div style="width:25px"></div>'}
            `;
            btnWrap.appendChild(btn); btnWrap.appendChild(arrows);
            adminBar.appendChild(btnWrap);
        });
        
        initializeHierarchyItems();
        initDynamicListeners();
    }

    async function initializeHierarchyItems() {
        const hierarchyScreen = screenConfigs.hierarchy;
        if (!hierarchyScreen || !hierarchyScreen.initial) return;
        
        const snapshot = await getDocs(collection(db, "hierarchy_items"));
        const existingItems = new Set(snapshot.docs.map(doc => doc.data().text));
        
        for (const item of hierarchyScreen.initial) {
            if (!existingItems.has(item)) {
                const itemId = item.toLowerCase().replace(/\s+/g, '_');
                await setDoc(doc(db, "hierarchy_items", itemId), {
                    text: item,
                    x: Math.random() * 300 + 50,
                    y: Math.random() * 300 + 50
                });
            }
        }
    }

    function updateVisuals() {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(`screen-${currentActiveId}`)?.classList.add('active');
        document.querySelectorAll('.screen-btn').forEach(b => b.classList.remove('current-btn'));
        document.getElementById(`btn-${currentActiveId}`)?.classList.add('current-btn');
    }

    function initDynamicListeners() {
        onSnapshot(query(collection(db, "user_cvs"), orderBy("timestamp", "desc")), (snap) => {
            const feed = document.getElementById('cv-live-feed');
            if(!feed) return;
            feed.innerHTML = "";
            snap.docs.forEach(doc => {
                const d = document.createElement('div'); d.className = 'ans-pill';
                d.style.marginBottom = "10px"; d.style.padding = "15px";
                d.innerText = doc.data().text; feed.appendChild(d);
            });
        });

        onSnapshot(query(collection(db, "live_questions"), orderBy("timestamp", "asc")), (snap) => {
            const inCont = document.getElementById('input-questions-container');
            const monCont = document.getElementById('monitor-questions-container');
            if(inCont) inCont.innerHTML = ""; if(monCont) monCont.innerHTML = "";
            snap.docs.forEach(docSnap => {
                const q = docSnap.data(); const qId = docSnap.id;
                if(inCont) {
                    const d = document.createElement('div'); d.className = 'vraag-blok';
                    d.innerHTML = `<p><strong>${q.text}</strong></p><input type="text" id="in-${qId}"><button class="action-btn" onclick="sendData('${qId}','answers_split','text','${qId}')">STUUR</button>`;
                    inCont.appendChild(d);
                }
                if(monCont) {
                    const d = document.createElement('div'); d.className = 'monitor-vraag';
                    d.innerHTML = `<h3>${q.text}</h3><div id="monitor-feed-${qId}"></div>`;
                    monCont.appendChild(d);
                }
            });
        });

        onSnapshot(collection(db, "answers_split"), (snap) => {
            snap.docs.forEach(d => {
                const feed = document.getElementById(`monitor-feed-${d.data().qId}`);
                if (feed && !document.getElementById(`m-ans-${d.id}`)) {
                    const s = document.createElement('span'); s.id = `m-ans-${d.id}`; s.className = 'ans-pill';
                    s.innerText = d.data().text; feed.appendChild(s);
                }
            });
        });

        // LIVE HIERARCHIE: Elke beweging wordt gedeeld
        onSnapshot(collection(db, "hierarchy_items"), (snap) => {
            const canvas = document.getElementById('canvas-hierarchy');
            if(!canvas) return;
            
            snap.docChanges().forEach(change => {
                const d = change.doc;
                const data = d.data();
                let el = document.getElementById(`shared-${d.id}`);
                
                if (change.type === 'added' || !el) {
                    if (!el) {
                        el = document.createElement('div'); 
                        el.id = `shared-${d.id}`; 
                        
                        let extraClass = '';
                        if (data.text === 'Jezus') extraClass = 'item-Jezus';
                        if (data.text === 'God') extraClass = 'item-God';
                        
                        el.className = `draggable ${extraClass}`;
                        el.innerText = data.text;
                        canvas.appendChild(el);
                        setupDragging(el, d.id, true);
                    }
                }
                
                if (el && data.x !== undefined && data.y !== undefined) {
                    el.style.left = data.x + "px";
                    el.style.top = data.y + "px";
                }
            });
        });

        // ONZE PSALM: Items worden alleen getoond, bewegingen worden NIET opgeslagen
        onSnapshot(collection(db, "poem_lines"), (snap) => {
            const canvas = document.getElementById('canvas-creation');
            if(!canvas) return;
            
            snap.docChanges().forEach(change => {
                const d = change.doc;
                if (change.type === 'added' && !document.getElementById(`poem-${d.id}`)) {
                    const el = document.createElement('div');
                    el.id = `poem-${d.id}`; 
                    el.className = 'draggable';
                    el.innerText = d.data().text;
                    // Startpositie: willekeurig maar zichtbaar
                    el.style.left = (Math.random() * 350 + 50) + "px";
                    el.style.top = (Math.random() * 350 + 50) + "px";
                    canvas.appendChild(el);
                    // isShared = false: bewegingen worden niet opgeslagen in Firebase
                    setupDragging(el, d.id, false);
                }
                if (change.type === 'removed') {
                    const el = document.getElementById(`poem-${d.id}`);
                    if (el) el.remove();
                }
            });
        });
    }

    onSnapshot(doc(db, "appState", "current"), (snap) => {
        currentActiveId = snap.data()?.activeScreen || 'login';
        updateVisuals();
    });

    renderApp();
</script>
</body>
</html>

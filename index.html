<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bijbelstudie OS - 8 Maart</title>
    <style>
        :root { --bg: #fdfcf8; --primary: #2c3e50; --accent: #8e44ad; --text: #34495e; --bible-bg: #fffcf0; }
        body { font-family: 'Georgia', serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; }
        .container { max-width: 800px; margin: 40px auto; padding: 20px; padding-bottom: 150px; }
        .screen { display: none; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #eee; min-height: 450px; }
        .active { display: block; animation: fadeIn 0.5s; }
        .bible-scroll-box { max-height: 400px; overflow-y: auto; padding: 25px; background: var(--bible-bg); border: 1px solid #d3c4a8; border-radius: 6px; text-align: left; line-height: 1.8; font-size: 1.1em; margin: 20px 0; }
        input, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { padding: 12px 24px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; }
        .feed { margin-top: 20px; text-align: left; border-top: 2px solid var(--bg); }
        .answer-item { background: #f9f9f9; padding: 10px; margin-bottom: 5px; border-radius: 4px; border-left: 3px solid var(--accent); }
        .draggable { position: absolute; padding: 10px 20px; background: white; border: 2px solid var(--primary); border-radius: 25px; cursor: move; box-shadow: 2px 5px 10px rgba(0,0,0,0.1); white-space: nowrap; font-family: sans-serif; font-weight: bold; z-index: 10; }
        .admin-bar { position: fixed; bottom: 0; width: 100%; background: #1a1a1a; padding: 10px; display: flex; overflow-x: auto; gap: 10px; z-index: 1000; }
        .admin-bar button { background: #444; font-size: 10px; padding: 5px 10px; white-space: nowrap; color: white; border-radius: 2px; }
        .admin-bar .current-btn { background: var(--accent); }
        .admin-bar .reset-btn { background: #c0392b; margin-left: auto; font-weight: bold; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container" id="main-container"></div>
<div class="admin-bar" id="admin-bar"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, doc, onSnapshot, setDoc, updateDoc, collection, addDoc, query, orderBy, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCcC2ZvkbWDuXLWSGmCpM2wfBnm65UYrbQ",
        authDomain: "z53bijbelstudie.firebaseapp.com",
        projectId: "z53bijbelstudie",
        storageBucket: "z53bijbelstudie.firebasestorage.app",
        messagingSenderId: "86708654444",
        appId: "1:86708654444:web:729295ba18f564b841a349"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const screens = [
        { id: 'login', title: 'Inloggen', type: 'input', label: 'Naam:', dbCol: 'names', field: 'name' },
        { id: 'goals', title: 'Doelen', type: 'info', content: 'Doelen voor vandaag: <br>1. Verbinding zoeken <br>2. HebreeÃ«n 2 ontdekken <br>3. Samen creatief zijn.' },
        { id: 'reading', title: 'Lezing', type: 'bible', text: '<b>[1]</b> Daarom moeten wij ons te meer houden aan wat door ons gehoord is... (vul aan)' },
        { id: 'q1', title: 'Vragen', type: 'qa', label: 'Wat valt je op in dit gedeelte?', dbCol: 'answers', field: 'text' },
        { id: 'concepts', title: 'Begrippen', type: 'static-dragdrop', items: ['Jezus', 'Mozes', 'Wet', 'Koningen' 'Beloofde land'], dbCol: 'static_elements' },
        { id: 'lines', title: 'Zinnen verzamelen', type: 'input', label: 'Typ een kernzin uit de tekst:', dbCol: 'poem_lines', field: 'text' },
        { id: 'creation', title: 'Psalm Vormen', type: 'dragdrop', dbCol: 'poem_lines' },
        { id: 'blessing', title: 'Zegen', type: 'info', content: 'Ga heen in vrede.' }
    ];

    const container = document.getElementById('main-container');
    const adminBar = document.getElementById('admin-bar');

    screens.forEach(s => {
        const div = document.createElement('div');
        div.id = `screen-${s.id}`;
        div.className = 'screen';
        let html = `<h2>${s.title}</h2>`;
        if (s.type === 'info') html += `<p>${s.content}</p>`;
        if (s.type === 'bible') html += `<div class="bible-scroll-box">${s.text}</div>`;
        if (s.type === 'input' || s.type === 'qa') {
            html += `<p>${s.label}</p><input id="in-${s.id}"><button onclick="sendData('${s.id}','${s.dbCol}','${s.field}')">Stuur</button><div class="feed" id="feed-${s.id}"></div>`;
        }
        if (s.type === 'dragdrop' || s.type === 'static-dragdrop') {
            html += `<div id="canvas-${s.id}" style="position:relative; height:500px; border:1px solid #ddd; background:#fff;"></div>`;
        }
        div.innerHTML = html;
        container.appendChild(div);

        const btn = document.createElement('button');
        btn.innerText = s.title;
        btn.id = `btn-${s.id}`;
        btn.onclick = () => updateRemoteScreen(s.id);
        adminBar.appendChild(btn);
    });

    // Reset Knop rechtsboven in Admin Bar
    const resetBtn = document.createElement('button');
    resetBtn.innerText = "DB WISSEN (RESET)";
    resetBtn.className = "reset-btn";
    resetBtn.onclick = () => resetAllData();
    adminBar.appendChild(resetBtn);

    window.sendData = async (id, col, field) => {
        const val = document.getElementById(`in-${id}`).value;
        if (val) {
            await addDoc(collection(db, col), { [field]: val, timestamp: Date.now(), x: 50, y: 50 });
            document.getElementById(`in-${id}`).value = "";
        }
    };

    window.updateRemoteScreen = async (id) => {
        await setDoc(doc(db, "appState", "current"), { activeScreen: id }, { merge: true });
    };

    async function resetAllData() {
        if(confirm("LET OP: Hiermee wis je alle namen, antwoorden en verzamelde zinnen voor iedereen. Doorgaan?")){
            const collectionsToClear = ['names', 'answers', 'poem_lines', 'static_elements'];
            for(const colName of collectionsToClear) {
                const qSnap = await getDocs(collection(db, colName));
                qSnap.forEach(d => deleteDoc(doc(db, colName, d.id)));
            }
            alert("Database is leeggemaakt!");
        }
    }

    onSnapshot(doc(db, "appState", "current"), (snap) => {
        const activeId = snap.data()?.activeScreen || 'login';
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(`screen-${activeId}`).classList.add('active');
        document.querySelectorAll('.admin-bar button').forEach(b => b.classList.remove('current-btn'));
        document.getElementById(`btn-${activeId}`)?.classList.add('current-btn');
    });

    screens.forEach(s => {
        if(s.dbCol) {
            onSnapshot(collection(db, s.dbCol), (snap) => {
                const feed = document.getElementById(`feed-${s.id}`);
                const canvas = document.getElementById(`canvas-${s.id}`);
                if (feed) {
                    feed.innerHTML = snap.docs.sort((a,b) => b.data().timestamp - a.data().timestamp)
                                              .map(d => `<div class="answer-item">${d.data()[s.field] || d.data().text}</div>`).join("");
                }
                if (canvas) {
                    if(s.type === 'static-dragdrop' && snap.empty) {
                        s.items.forEach((txt, i) => addDoc(collection(db, s.dbCol), { text: txt, x: 20, y: 50 + (i*60) }));
                    }
                    snap.docs.forEach(docSnap => {
                        let el = document.getElementById(`drag-${docSnap.id}`);
                        if(!el) {
                            el = document.createElement('div');
                            el.id = `drag-${docSnap.id}`;
                            el.className = 'draggable';
                            el.innerText = docSnap.data().text;
                            canvas.appendChild(el);
                            setupDragging(el, s.dbCol, docSnap.id, canvas);
                        }
                        el.style.left = docSnap.data().x + "px";
                        el.style.top = docSnap.data().y + "px";
                    });
                }
            });
        }
    });

    function setupDragging(el, col, docId, canvas) {
        let active = false;
        el.onmousedown = () => active = true;
        document.onmouseup = () => active = false;
        document.onmousemove = (e) => {
            if(!active) return;
            const r = canvas.getBoundingClientRect();
            updateDoc(doc(db, col, docId), { x: e.clientX - r.left - 50, y: e.clientY - r.top - 20 });
        };
    }
</script>
</body>
</html>
